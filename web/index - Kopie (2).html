<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Qt Secure Server – Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin: 1.5rem; }
    nav { display:flex; gap:.8rem; margin-bottom:1rem; }
    nav button { padding:.5rem .8rem; cursor:pointer; }
    .page { display:none; }
    .page.active { display:block; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin:.5rem 0; }
    input,button { padding:.45rem .6rem; }
    code { background:#f5f5f5; padding:.15rem .3rem; }
    canvas { width:100%; height:280px; border:1px solid #ddd; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border:1px solid #ddd; padding:.4rem; }
    pre.log { background:#111;color:#ddd;padding:10px; height:260px; overflow:auto; }
    small.muted { color:#666 }
    .ok { color:#2a7 }
    .err{ color:#b33 }
  </style>
</head>
<body>
  <h1>Qt Secure Server</h1>
  <nav>
    <button data-page="home">Home</button>
    <button data-page="live">Live</button>
    <button data-page="ota">OTA</button>
  </nav>

  <!-- ===================== HOME ===================== -->
  <section id="home" class="page active">
    <h2>Home</h2>
    <div class="row">
      <form id="frmNumber">
        <label>Zahl: <input type="number" name="value" required /></label>
        <button type="submit">Senden</button>
      </form>
    </div>

    <h3>Login</h3>
    <div class="row">
      <input id="user" placeholder="user" value="admin">
      <input id="pass" placeholder="passwort" type="password" value="secret_admin">
      <button id="btnLogin">Login (HTTP)</button>
      <span id="loginMsg" class="small muted"></span>
    </div>

    <h3>Sensor Latest</h3>
    <div class="row">
      <input id="limit" type="number" placeholder="Limit" value="10">
      <button id="btnLoad">Laden</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Name</th><th>Value</th></tr></thead>
      <tbody id="latestBody"></tbody>
    </table>
  </section>

  <!-- ===================== LIVE ===================== -->
  <section id="live" class="page">
    <h2>Live</h2>
    <div class="row">
      <input id="wsUrl" placeholder="wss://host:9443" style="min-width:18rem">
      <button id="btnWs">Verbinden</button>
      <span id="wsStatus" class="small muted"></span>
    </div>
    <canvas id="chart" width="800" height="280"></canvas>

    <h3>Live Events</h3>
    <pre id="log" class="log"></pre>
  </section>

    <!-- ===================== OTA ===================== -->
  <section id="ota" class="page">
    <h2>OTA Admin</h2>
    <p class="small muted">Login nötig (JWT). Datei-Upload via <code>PUT /api/ota/upload</code>, Zuordnung via <code>POST /api/ota/assign</code>.</p>
//----------------- Sehen was in Devices liegt
<h3>Devices</h3>
<div class="row">
  <button id="btnListDevs">Liste laden</button>
  <span id="devMsg" class="small muted"></span>
</div>
<table>
  <thead><tr><th>Key</th><th>Enabled</th><th>Created</th><th>Updated</th></tr></thead>
  <tbody id="devBody"></tbody>
</table>
// -----------------------------------------------------
    <div class="row">
      <label>Datei<br><input id="otaFile" type="file" accept=".bin,.img,.fw"></label>
      <label>Name (optional)<br><input id="otaName" placeholder="fw.bin"></label>
      <button id="btnUpload">Upload</button>
      <span id="otaMsg" class="small muted"></span>
    </div>

    <div class="row">
      <label>Device Key<br><input id="devKey" placeholder="dev-001"></label>
      <label>File ID<br><input id="fileId" placeholder="1"></label>
      <button id="btnAssign">Assign</button>
      <span id="assignMsg" class="small muted"></span>
    </div>
  </section>

  <script>
    // ---------- Navigation ----------
    document.querySelectorAll('nav button').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById(b.dataset.page).classList.add('active');
      });
    });

    // ---------- Helpers ----------
    const $ = sel => document.querySelector(sel);
    const log = (...a) => { const el = $("#log"); el.textContent += a.join(" ")+"\n"; el.scrollTop = el.scrollHeight; };
    const setText = (sel, text, cls) => { const el=$(sel); el.textContent=text; el.className = (cls||'small muted'); };

    // Fetch-Helper mit optionalem Bearer (JWT) & Binär
    async function http(method, path, {body, bearer, headers} = {}) {
      const opts = { method, headers: { ...(headers||{}) } };
      if (body instanceof ArrayBuffer || body instanceof Blob || body instanceof Uint8Array) {
        opts.body = body; // Content-Type für Binär nicht setzen
      } else if (body != null) {
        opts.headers["Content-Type"] = "application/json";
        opts.body = JSON.stringify(body);
      }
      if (bearer) opts.headers["Authorization"] = "Bearer " + bearer;
      const res  = await fetch(path, opts);
      const text = await res.text();
      let data=null; try { data = JSON.parse(text); } catch {}
      return {status: res.status, data, text};
    }

    // ---------- Zahl submit ----------
    $("#frmNumber").addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const r = await fetch('/submit',{method:'POST', body:new URLSearchParams(fd)});
      alert(await r.text());
      e.target.reset();
    });

    // ---------- Login (/login → JWT) ----------
    $("#btnLogin").addEventListener('click', async ()=>{
      const user = $("#user").value.trim();
      const pass = $("#pass").value;
      setText("#loginMsg","login…");
      try {
        const r = await fetch('/login',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user, pass})});
        const j = await r.json().catch(()=>({}));
        if (j.token) {
          localStorage.setItem('token', j.token);
          setText("#loginMsg","ok (JWT gespeichert)","ok");
        } else {
          setText("#loginMsg","Fehler","err");
        }
      } catch (e) {
        setText("#loginMsg","Error","err");
      }
    });

    // ---------- Sensor latest ----------
    $("#btnLoad").addEventListener('click', async ()=>{
      const limit = $("#limit").value || 10;
      const r = await fetch('/api/sensor/latest?limit='+encodeURIComponent(limit));
      const j = await r.json().catch(()=>({items:[]}));
      const tbody = $("#latestBody"); tbody.innerHTML='';
      (j.items||[]).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.id}</td><td>${it.name}</td><td>${it.value}</td>`;
        tbody.appendChild(tr);
      });
    });

    // ---------- Live-Chart ----------
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const data = []; const MAX=100;
    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // Achsen
      ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,260); ctx.lineTo(790,260); ctx.stroke();
      // Daten
      if (data.length<2) return;
      const min = Math.min(...data), max = Math.max(...data);
      const range = (max-min)||1;
      ctx.beginPath();
      data.forEach((v,i)=>{
        const x = 40 + i*(750/(MAX-1));
        const y = 260 - ((v-min)/range)*240;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }
    function pushValue(v){ if (!isFinite(v)) return; data.push(v); if (data.length>MAX) data.shift(); draw(); }

    // ---------- WebSocket ----------
    let ws=null;
    const defaultWsUrl = `wss://${location.hostname}:9443`;
    document.addEventListener('DOMContentLoaded', ()=>{ const el=$("#wsUrl"); if (el && !el.value) el.value = defaultWsUrl; });

    $("#btnWs").addEventListener('click', ()=>{
      if (ws && (ws.readyState===WebSocket.OPEN||ws.readyState===WebSocket.CONNECTING)) { ws.close(); ws=null; setText("#wsStatus","Getrennt"); return; }
      const url = $("#wsUrl").value.trim() || defaultWsUrl;
      setText("#wsStatus","Verbinde…");
      ws = new WebSocket(url);
      ws.onopen = ()=>{
        setText("#wsStatus","Verbunden");
        const token = localStorage.getItem('token')||'';
        ws.send(JSON.stringify({cmd:'auth', token}));
      };
      ws.onmessage = (ev)=>{
        // Generische Ausgabe
        log("WS <", ev.data);
        // JSON interpretieren (sensor/ota/auth)
        try {
          const msg = JSON.parse(ev.data);
          if (msg.status==="ok" && msg.msg==="authenticated") {
            setText("#wsStatus","Authentifiziert","ok");
          }
          if (msg.sensor) {
            // Nimm ersten numerischen Wert für die Linie
            const vals = msg.sensor.values||{};
            const firstNum = Object.values(vals).map(v=>Number(v)).find(v=>isFinite(v));
            if (firstNum!=null) pushValue(firstNum);
          }
          if (msg.value!=null) { // kompatibel zu altem {"value":42}
            pushValue(Number(msg.value));
          }
        } catch {
          const num = Number(ev.data);
          if (!Number.isNaN(num)) pushValue(num);
        }
      };
      ws.onclose = ()=> setText("#wsStatus","Getrennt");
      ws.onerror = ()=> setText("#wsStatus","WS-Fehler","err");
    });

    // ---------- OTA: Upload (PUT /api/ota/upload) ----------
    $("#btnUpload").addEventListener('click', async ()=>{
      const f = $("#otaFile").files[0];
      if (!f) { setText("#otaMsg","Bitte Datei wählen","err"); return; }
      const name = $("#otaName").value.trim();
      const token = localStorage.getItem('token')||'';
      if (!token) { setText("#otaMsg","Bitte zuerst einloggen (JWT)","err"); return; }

      const path = name ? `/api/ota/upload?name=${encodeURIComponent(name)}` : `/api/ota/upload`;
      setText("#otaMsg","Upload…");
      const {status, data, text} = await http("PUT", path, { body: f, bearer: token });
      if (status===200 && data?.file_id) {
        $("#fileId").value = data.file_id;
        setText("#otaMsg",`OK: id=${data.file_id}, size=${data.size}, sha256=${data.sha256}`,"ok");
        log("UPLOAD <", JSON.stringify(data));
      } else {
        setText("#otaMsg",`Fehler: ${status} ${text||''}`,"err");
      }
    });

// ----------------------------Sehen was in devices liegt ---------------
document.getElementById('btnListDevs').addEventListener('click', async ()=>{
  const token = localStorage.getItem('token')||'';
  if (!token) { setText("#devMsg","Bitte einloggen (JWT)","err"); return; }
  setText("#devMsg","Lade…");
  const {status, data, text} = await (async () => {
    const r = await fetch('/api/devices', { headers: { 'Authorization': 'Bearer '+token }});
    const t = await r.text(); let j=null; try{j=JSON.parse(t);}catch{}; return {status:r.status, data:j, text:t};
  })();
  if (status!==200) { setText("#devMsg","Fehler: "+status,"err"); return; }
  const tb = document.getElementById('devBody'); tb.innerHTML='';
  (data.items||[]).forEach(d=>{
    const tr = document.createElement('tr');
    const fmt = (x)=> x? new Date(x*1000).toLocaleString(): '';
    tr.innerHTML = `<td>${d.key_id}</td><td>${d.enabled? 'yes':'no'}</td><td>${fmt(d.created_at)}</td><td>${fmt(d.updated_at)}</td>`;
    tb.appendChild(tr);
  });
  setText("#devMsg",`OK (${(data.items||[]).length} Geräte)`,"ok");
});

    

// ---------- OTA: Assign (POST /api/ota/assign) ----------
    $("#btnAssign").addEventListener('click', async ()=>{
      const token = localStorage.getItem('token')||'';
      if (!token) { setText("#assignMsg","Bitte zuerst einloggen (JWT)","err"); return; }
      const device_key = $("#devKey").value.trim();
      const file_id    = parseInt($("#fileId").value,10);
      if (!device_key || !file_id) { setText("#assignMsg","device_key und file_id angeben","err"); return; }

      setText("#assignMsg","Sende…");
      const {status, data, text} = await http("POST","/api/ota/assign",{ bearer: token, body:{ device_key, file_id }});
      if (status===200 && data?.job_id) {
        setText("#assignMsg",`OK: job_id=${data.job_id}`,"ok");
        log("ASSIGN <", JSON.stringify(data));
      } else {
        setText("#assignMsg",`Fehler: ${status} ${text||''}`,"err");
      }
    });
  </script>
</body>
</html>
